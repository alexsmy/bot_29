<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telegram Caller - –ó–≤–æ–Ω–æ–∫</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div id="app-container">
        <!-- –≠–ö–†–ê–ù 1: –ü–†–û–í–ï–†–ö–ê –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø -->
        <div id="pre-call-check-screen" class="screen">
            <div class="check-container">
                <p class="check-subtitle">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.</p>

                <div class="media-preview-area">
                    <video id="previewVideo" autoplay muted playsinline></video>
                    <div class="mic-level-meter">
                        <div class="mic-level-bar"></div>
                        <div class="mic-level-bar"></div>
                        <div class="mic-level-bar"></div>
                        <div class="mic-level-bar"></div>
                        <div class="mic-level-bar"></div>
                    </div>
                </div>

                <div class="compact-grid device-selectors">
                    <div id="camera-select-container" class="device-selector" style="display: none;">
                        <label for="camera-select">–ö–∞–º–µ—Ä–∞:</label>
                        <select id="camera-select"></select>
                    </div>
                    <div id="mic-select-container" class="device-selector" style="display: none;">
                        <label for="mic-select">–ú–∏–∫—Ä–æ—Ñ–æ–Ω:</label>
                        <select id="mic-select"></select>
                    </div>
                    <div id="speaker-select-container" class="device-selector" style="display: none;">
                        <label for="speaker-select">–î–∏–Ω–∞–º–∏–∫:</label>
                        <select id="speaker-select"></select>
                    </div>
                </div>

                <div class="compact-grid status-indicators">
                    <div class="status-item" id="camera-status">
                        <span class="status-icon">üì∑</span>
                        <span class="status-text" id="camera-status-text">–ö–∞–º–µ—Ä–∞: ...</span>
                    </div>
                    <div class="status-item" id="mic-status">
                        <span class="status-icon">üé§</span>
                        <span class="status-text" id="mic-status-text">–ú–∏–∫—Ä–æ—Ñ–æ–Ω: ...</span>
                    </div>
                </div>

                <button id="continue-to-call-btn" class="continue-btn" disabled>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <button id="continue-spectator-btn" class="continue-btn spectator" style="display: none;">–í–æ–π—Ç–∏ –∫–∞–∫ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å</button>
            </div>
        </div>

        <!-- –≠–ö–†–ê–ù 2: –û–ñ–ò–î–ê–ù–ò–ï –ò –í–´–ë–û–† –î–ï–ô–°–¢–í–ò–Ø -->
        <div id="pre-call-screen" class="screen">
            <header class="pre-call-header">
                <h1>–ü—Ä–∏–≤–∞—Ç–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ –¥–ª—è –∑–≤–æ–Ω–∫–∞</h1>
                <p>–≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è —Å–≤—è–∑–∏ –º–µ–∂–¥—É –¥–≤—É–º—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞–º–∏.</p>
            </header>

            <main class="pre-call-center">
                <div id="popup-waiting" class="popup">
                    <h2>–û–∂–∏–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</h2>
                    <div class="spinner"></div>
                </div>

                <div id="popup-actions" class="popup">
                    <h2>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫–∏ –æ–Ω–ª–∞–π–Ω</h2>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –í–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –∞—É–¥–∏–æ- –∏ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫.</p>
                    <div class="call-actions-container">
                        <button class="action-call-btn audio" data-call-type="audio">
                            <span data-icon-name="audioCall"></span>
                            <span>–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫</span>
                        </button>
                        <button class="action-call-btn video" data-call-type="video">
                            <span data-icon-name="videoCall"></span>
                            <span>–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</span>
                        </button>
                    </div>
                </div>

                <div id="popup-initiating" class="popup">
                    <h2>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞—á–∞–ª –≤—ã–∑–æ–≤...</h2>
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∂–∏–¥–∞–π—Ç–µ.</p>
                </div>
            </main>

            <footer class="pre-call-footer">
                <div class="info-block-lifetime">
                    <p>–í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è —ç—Ç–æ–π —Å—Å—ã–ª–∫–∏:</p>
                    <div id="lifetime-timer">--:--</div>
                    <p>–õ—é–±–æ–π –∏–∑ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤ –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ–∞–Ω—Å, –∑–∞–∫—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.</p>
                    <div class="footer-actions">
                        <button id="close-session-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
                        {% if bot_username %}
                        <a href="https://t.me/{{ bot_username }}" target="_blank">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É</a>
                        {% endif %}
                    </div>
                </div>
                <div class="info-block-security">
                    <button id="instructions-btn" class="instructions-btn">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</button>
                </div>
            </footer>
        </div>

        <!-- –≠–ö–†–ê–ù 3: –ó–í–û–ù–û–ö -->
        <div id="call-screen" class="screen">
            <video id="remoteVideo" autoplay playsinline></video>

            <div id="local-video-container">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="view-controls">
                    <button id="toggle-local-view-btn" class="view-control-btn" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥ (–ª–æ–∫–∞–ª—å–Ω—ã–π)">
                        <span class="icon" data-icon-name="localViewContain"></span>
                    </button>
                    <button id="toggle-remote-view-btn" class="view-control-btn" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥ (—É–¥–∞–ª–µ–Ω–Ω—ã–π)">
                        <span class="icon" data-icon-name="remoteViewCover"></span>
                    </button>
                </div>
            </div>

            <div id="audio-call-visualizer">
                <div class="avatar-container local">
                    <div class="glow" id="local-glow"></div>
                    <span data-icon-name="audioAvatarLocal"></span>
                </div>
                <div class="data-flow">
                    <span></span><span></span><span></span><span></span><span></span>
                </div>
                <div class="avatar-container remote">
                    <div class="glow" id="remote-glow"></div>
                    <span data-icon-name="audioAvatarRemote"></span>
                </div>
            </div>

            <div class="call-ui-overlay">
                <div class="top-info">
                    <div id="connection-status" title="–ö–∞—á–µ—Å—Ç–≤–æ / –¢–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è">
                        <span id="connection-quality" class="icon">
                            <span data-icon-name="qualityGood" id="quality-good-svg" class="quality-svg"></span>
                            <span data-icon-name="qualityMedium" id="quality-medium-svg" class="quality-svg"></span>
                            <span data-icon-name="qualityBad" id="quality-bad-svg" class="quality-svg"></span>
                        </span>
                        <span class="icon" id="conn-local" data-icon-name="connLocal"></span>
                        <span class="icon" id="conn-p2p" data-icon-name="connP2P"></span>
                        <span class="icon" id="conn-relay" data-icon-name="connRelay"></span>
                        <span class="icon" id="conn-unknown" data-icon-name="connUnknown"></span>
                    </div>
                    <div id="connection-info-popup" class="connection-info-popup"></div>
                    <div id="remote-audio-level" class="remote-audio-level-container">
                        <div class="remote-audio-level-bar"></div>
                        <div class="remote-audio-level-bar"></div>
                        <div class="remote-audio-level-bar"></div>
                        <div class="remote-audio-level-bar"></div>
                        <div class="remote-audio-level-bar"></div>
                    </div>
                </div>

                <div class="center-info">
                    <div class="caller-info-top">
                        <h2 id="remote-user-name">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                        <p id="call-timer">00:00</p>
                    </div>
                </div>

                <div class="bottom-controls">
                    <div class="call-controls-grid">
                        <div class="control-item">
                            <button id="mute-btn" class="control-btn">
                                <span class="icon-on" data-icon-name="micOn"></span>
                                <span class="icon-off" data-icon-name="micOff"></span>
                            </button>
                            <span>–ú–∏–∫—Ä–æ—Ñ–æ–Ω</span>
                        </div>
                        <div class="control-item" id="video-control-item">
                            <button id="video-btn" class="control-btn">
                                <span class="icon-on" data-icon-name="videoOn"></span>
                                <span class="icon-off" data-icon-name="videoOff"></span>
                            </button>
                            <span>–ö–∞–º–µ—Ä–∞</span>
                        </div>
                        <div class="control-item">
                            <button id="speaker-btn" class="control-btn">
                                <span class="icon-on" data-icon-name="speakerOn"></span>
                                <span class="icon-off" data-icon-name="speakerOff"></span>
                            </button>
                            <span>–î–∏–Ω–∞–º–∏–∫</span>
                        </div>
                        <div class="control-item" id="device-settings-control-item">
                            <button id="device-settings-btn" class="control-btn">
                                <span class="icon-on" data-icon-name="settings"></span>
                            </button>
                            <span>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</span>
                        </div>
                        <div class="control-item" id="screen-share-control-item" style="display: none;">
                            <button id="screen-share-btn" class="control-btn">
                                <span class="icon-on" data-icon-name="screenShareOn"></span>
                                <span class="icon-off" data-icon-name="screenShareOff"></span>
                            </button>
                            <span>–≠–∫—Ä–∞–Ω</span>
                        </div>
                    </div>

                    <div class="hangup-wrapper">
                        <button id="hangup-btn" class="hangup-btn">
                            <span data-icon-name="hangup"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="remote-mute-toast" class="toast-notification"></div>
    </div>

    <div id="incoming-call-modal" class="modal">
        <div class="modal-content">
            <div class="caller-info-modal">
                <h3 id="caller-name">–í–∞–º –∑–≤–æ–Ω–∏—Ç...</h3>
                <p id="incoming-call-type">Telegram Call</p>
            </div>
            <div class="modal-buttons">
                <div class="action-button-wrapper">
                    <button id="decline-btn" class="action-btn decline-btn">
                        <span data-icon-name="decline"></span>
                    </button>
                    <span>–û—Ç–∫–ª–æ–Ω–∏—Ç—å</span>
                </div>
                <div class="action-button-wrapper">
                    <button id="accept-btn" class="action-btn accept-btn">
                        <span data-icon-name="accept"></span>
                    </button>
                    <span>–ü—Ä–∏–Ω—è—Ç—å</span>
                </div>
            </div>
        </div>
    </div>

    <div id="instructions-modal" class="modal-instructions">
        <div class="modal-overlay"></div>
        <div class="modal-instructions-content">
            <button class="close-instructions-btn top">–ó–∞–∫—Ä—ã—Ç—å</button>
            <div class="instructions-content">
                {% include 'instructions_call.html' %}
            </div>
            <button class="close-instructions-btn bottom">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="device-settings-modal" class="modal-instructions">
        <div class="modal-overlay"></div>
        <div class="modal-instructions-content">
            <button class="close-settings-btn top">–ó–∞–∫—Ä—ã—Ç—å</button>
            <div class="settings-content">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h2>
                <div class="device-selectors-modal">
                    <div id="camera-select-container-call" class="device-selector" style="display: none;">
                        <label for="camera-select-call">–ö–∞–º–µ—Ä–∞:</label>
                        <select id="camera-select-call"></select>
                    </div>
                    <div id="mic-select-container-call" class="device-selector" style="display: none;">
                        <label for="mic-select-call">–ú–∏–∫—Ä–æ—Ñ–æ–Ω:</label>
                        <select id="mic-select-call"></select>
                    </div>
                    <div id="speaker-select-container-call" class="device-selector" style="display: none;">
                        <label for="speaker-select-call">–î–∏–Ω–∞–º–∏–∫:</label>
                        <select id="speaker-select-call"></select>
                    </div>
                </div>
            </div>
            <button class="close-settings-btn bottom">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <audio id="localAudio" autoplay muted playsinline style="display:none;"></audio>
    <audio id="remoteAudio" autoplay playsinline></audio>

    <audio id="ringOutAudio" loop src="/static/sounds/ring-out.mp3"></audio>
    <audio id="connectAudio" src="/static/sounds/connect.mp3"></audio>
    <audio id="ringInAudio" loop src="/static/sounds/ring-in.mp3"></audio>

    <script src="/static/js/icons.js"></script>
    <script src="/static/js/main.js"></script>
</body>
</html>